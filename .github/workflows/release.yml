name: Release PR
on:
  pull_request:
    types:
      - opened
      - closed
      - synchronize
    branches:
      - v1

jobs:
  update-release-content:
    if: contains(github.head_ref, 'release/v')
    runs-on: ubuntu-latest
    env:
      BRANCH_NAME: ${{ github.event.pull_request.head.ref }}
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: 14
      - run: npm install lodash.groupby
      - name: Update content of release ðŸ“–
        uses: actions/github-script@v5
        with:
          script: |
            const groupBy = require('lodash.groupby');
            const { BRANCH_NAME } = process.env;
            const version = BRANCH_NAME.replace('release/', '');
            const params = [
              'repo:' + context.repo.owner + '/' + context.repo.repo,
              'type:pr',
              'milestone:' + version,
              'state:closed'
            ]
            const issue = await github.request('GET /search/issues', {
              q: params.join('+')
            });

            const milestone = groupBy(issue.data.items, pr => pr.assignee.login);

            const newLine = `

            @`;

            const header = `## Type
            **RELEASE**

            ## Description`;

            const body = Object.keys(milestone).reduce((description, assignee) => {
              description = description + newLine + assignee
              const listPR = milestone[assignee]
              const prContent = listPR.map(pr => '\n- ' + pr.pull_request.html_url)
              return description + prContent
            }, header);

            console.log(body);

            github.rest.pulls.update({
              body,
              pull_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

  create-release:
    if: ${{ contains(github.head_ref, 'release/v') && github.event.action == 'synchronize' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: 14
      - name: Create release
        uses: actions/github-script@v5
        env:
          BRANCH_NAME: ${{ github.event.pull_request.head.ref }}
        with:
          script: |
            const { BRANCH_NAME } = process.env;
            const { owner, repo } = context.repo;
            const tag_name = BRANCH_NAME.replace('release/', '')

            const allMilestone = await github.rest.issues.listMilestones({
              owner,
              repo
            });

            const currentMilestone = allMilestone.data.find(milestone => milestone.title === tag_name);

            if (!currentMilestone) return;

            const release_due_on = currentMilestone.due_on;
            const releaseDate = new Date(release_due_on);
            const tag_time = `${releaseDate.getFullYear()}-${releaseDate.getMonth() + 1}-${releaseDate.getDate()}`;

            const release = await github.rest.repos.createRelease({
              owner,
              repo,
              tag_name,
              name: `${tag_name.replace('v','')} [${tag_time}]`,
              draft: true,
              generate_release_notes: true
            });

  create-milestone:
    if: ${{ contains(github.head_ref, 'release/v') && github.event.action == 'synchronize' }}
    runs-on: ubuntu-latest
    needs: create-release
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: 14
      - run: npm install @slack/webhook
      - name: Create next milestone
        uses: actions/github-script@v5
        env:
          SLACK_URL: ${{ secrets.SLACK_HOOK }}
          BRANCH_NAME: ${{ github.head_ref }}
        with:
          script: |
            const BRANCH_NAME = process.env.BRANCH_NAME;
            const { IncomingWebhook } = require('@slack/webhook');
            const { owner, repo } = context.repo;
            const tag_name = BRANCH_NAME.replace('release/', '')
            const date = new Date();

            const allMilestones = await github.rest.issues.listMilestones({
              owner,
              repo
            })

            const currentMilestone = allMilestones.data.find(milestone => milestone.title === tag_name);

            date.setUTCDate(date.getUTCDate() + (8 - date.getUTCDay()));
            date.setHours(12)
            const versions = currentMilestone.title.split('.');
            versions[2] = Number(versions[2]) + 1;
            const nextVersion =  versions.join('.')

            const nextMilestone = await github.rest.issues.createMilestone({
              owner,
              repo,
              title: nextVersion,
              due_on: date.toISOString()
            })

            if (nextMilestone) {
              const web_hook_url = process.env.SLACK_URL;
              const web_hook_config = {
                username: 'GitHub Release bot',
                icon_url: 'https://octodex.github.com/images/bouncercat.png'
              };
              const webhook = new IncomingWebhook(web_hook_url, web_hook_config);
              const { html_url, title } = nextMilestone.data;

              webhook.send({
                text: `Thank everyone for your contribution to our latest release ðŸŽ‰ðŸŽ‰ðŸŽ‰ \n The next release is <${html_url}|${title}> \n Remember to link your PRs to this milestone so you wonâ€™t miss the release :wink:`
              })
            }